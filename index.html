<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ì‹¬ë¦¬í…ŒìŠ¤íŠ¸ â€” ë‹¤ì¤‘ ì‹œê°í™” (E/S/O/C)</title>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
  :root{
    --accent:#6366f1;
    --bg-light:linear-gradient(120deg,#eef2ff,#e0e7ff);
    --bg-dark:linear-gradient(120deg,#0f172a,#1e293b);
    --card-light:#ffffff;
    --card-dark:rgba(17,24,39,0.9);
    --text-dark:#0f172a;
    --text-light:#f8fafc;
  }
  html,body{height:100%; margin:0; font-family:Inter, "Pretendard", "Noto Sans KR", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;}
  body {
    display:flex;
    align-items:center;
    justify-content:center;
    padding:20px;
    background:var(--bg-light);
    transition: background .4s ease, color .3s ease;
  }
  body.dark{background:var(--bg-dark); color:var(--text-light);}

  .card{
    width:100%; max-width:900px;
    border-radius:16px;
    background:var(--card-light);
    box-shadow:0 10px 30px rgba(2,6,23,0.08);
    padding:20px;
    transition: background .3s ease, color .3s ease;
  }
  body.dark .card{ background:var(--card-dark); color:var(--text-light); box-shadow:0 8px 30px rgba(2,6,23,0.5); }

  header{ display:flex; gap:12px; align-items:center; justify-content:space-between; margin-bottom:12px; }
  header h1{ margin:0; font-size:1.2rem; background:linear-gradient(45deg,#4f46e5,#8b5cf6); -webkit-background-clip:text; color:transparent; }
  .meta { display:flex; gap:8px; align-items:center; }

  .controls { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }

  select, .btn {
    padding:8px 12px; border-radius:10px; border:1px solid #e6e9f2; background:transparent;
    font-size:0.95rem;
  }
  .btn { background:var(--accent); color:white; border:none; cursor:pointer; box-shadow:0 6px 18px rgba(99,102,241,0.12); }
  .btn:active{ transform:translateY(1px); }

  main { display:flex; gap:18px; align-items:flex-start; flex-wrap:wrap; }

  /* left: quiz area */
  .quiz {
    flex:1 1 360px; min-width:280px;
  }
  .start-box, .question-card, .result-card {
    border-radius:12px; padding:14px; background:rgba(255,255,255,0.97);
    box-shadow:0 6px 18px rgba(2,6,23,0.04);
  }
  body.dark .start-box, body.dark .question-card, body.dark .result-card { background: rgba(255,255,255,0.03); }

  .intro { color:#475569; margin:6px 0 12px 0; font-size:0.95rem; line-height:1.4; }
  .question-title{ font-weight:700; margin:8px 0; font-size:1rem; }

  .choices { display:flex; flex-direction:column; gap:10px; margin-top:8px; }
  .choice {
    padding:12px 14px; border-radius:10px; cursor:pointer; user-select:none;
    background: #f8fafc; color:var(--text-dark); border:1px solid transparent;
    transition: all .18s ease;
  }
  .choice:hover{ transform:translateY(-3px); border-color:rgba(99,102,241,0.15); background:#eef2ff; color:#1e3a8a; }
  .choice.selected{ background: linear-gradient(90deg,#6366f1,#a78bfa); color:white; transform:scale(1.02); box-shadow:0 8px 20px rgba(99,102,241,0.12); }

  /* progress */
  .progress{ height:10px; background:#eef2ff; border-radius:999px; margin:12px 0; overflow:hidden; }
  .progress > .fill{ height:100%; width:0%; background:linear-gradient(90deg,#6366f1,#8b5cf6); transition:width .3s ease; }

  /* right: visualization area */
  .visual {
    width:360px; flex:0 0 360px; min-width:260px;
    display:flex; flex-direction:column; gap:12px;
  }
  .chart-wrap{ border-radius:12px; padding:12px; background:rgba(255,255,255,0.98); box-shadow:0 6px 18px rgba(2,6,23,0.04); height:360px; display:flex; flex-direction:column; }
  body.dark .chart-wrap { background: rgba(255,255,255,0.03); }

  .chart-controls { display:flex; gap:8px; align-items:center; margin-bottom:8px; flex-wrap:wrap; }
  .chart-controls label{ font-size:0.9rem; color: #334155; }
  body.dark .chart-controls label{ color:#cbd5e1; }

  .small{ font-size:0.9rem; color:#64748b; }
  body.dark .small{ color:#cbd5e1; }

  /* responsive */
  @media (max-width:980px) {
    main{ flex-direction:column-reverse; align-items:stretch; }
    .visual{ width:100%; flex:1 1 auto; min-width:unset; }
  }
</style>
</head>
<body>
  <div class="card" role="application" aria-label="ì‹¬ë¦¬í…ŒìŠ¤íŠ¸">
    <header>
      <h1>ì‹¬ë¦¬í…ŒìŠ¤íŠ¸ â€” ë‹¤ì–‘í•œ ì‹œê°í™”</h1>
      <div class="meta">
        <div class="controls">
          <select id="langSelect" aria-label="ì–¸ì–´ ì„ íƒ"></select>
          <button class="btn" id="startBtn">ì‹œì‘</button>
        </div>
      </div>
    </header>

    <main>
      <!-- QUIZ COLUMN -->
      <section class="quiz">
        <div id="startBox" class="start-box">
          <p class="intro" id="introText">ì§ˆë¬¸ì— ë‹µí•˜ë©´ E/S/O/C ì„±í–¥ì„ ë¶„ì„í•´ ë“œë¦½ë‹ˆë‹¤. ì–¸ì–´ë¥¼ ì„ íƒí•œ ë’¤ ì‹œì‘í•˜ì„¸ìš”.</p>
          <div class="small">ìŒì„± ì•ˆë‚´ê°€ ì§€ì›ë˜ë©´ ìë™ìœ¼ë¡œ ì½ì–´ì¤ë‹ˆë‹¤.</div>
        </div>

        <div id="questionCard" class="question-card" style="display:none; margin-top:12px;">
          <div class="progress"><div class="fill" id="progressFill"></div></div>
          <div class="question-title" id="questionTitle">ì§ˆë¬¸</div>
          <div class="choices" id="choices"></div>
        </div>

        <div id="resultCard" class="result-card" style="display:none; margin-top:12px;">
          <h3 id="resultTitle">ê²°ê³¼</h3>
          <p id="resultSummary" class="small"></p>
          <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:8px;">
            <button class="btn" id="downloadBtn">ì°¨íŠ¸ ì´ë¯¸ì§€ ì €ì¥</button>
            <button class="btn" id="shareBtn">ê³µìœ </button>
            <button class="btn" id="restartBtn">ë‹¤ì‹œí•˜ê¸°</button>
          </div>
        </div>
      </section>

      <!-- VISUAL COLUMN -->
      <aside class="visual">
        <div class="chart-wrap">
          <div class="chart-controls">
            <label for="chartType">ê·¸ë˜í”„ ìœ í˜•:</label>
            <select id="chartType" aria-label="ì°¨íŠ¸ ìœ í˜•">
              <option value="bar">ë§‰ëŒ€(Bar)</option>
              <option value="radar">ë ˆì´ë”(Radar)</option>
              <option value="doughnut">ë„ë„›(Doughnut)</option>
              <option value="pie">íŒŒì´(Pie)</option>
            </select>

            <label style="margin-left:8px;"><input type="checkbox" id="compareAvg"> í‰ê· ê³¼ ë¹„êµ</label>
            <div style="flex:1"></div>
            <div class="small" id="chartHint">ì°¨íŠ¸ëŠ” ê²°ê³¼ ì™„ë£Œ í›„ ìë™ìœ¼ë¡œ í‘œì‹œë©ë‹ˆë‹¤.</div>
          </div>

          <div style="flex:1; position:relative;">
            <canvas id="resultChart" aria-label="ê²°ê³¼ ì°¨íŠ¸" role="img" style="width:100%; height:100%;"></canvas>
          </div>
        </div>

        <div style="text-align:center;" class="small">â€» ë‹¤ì–‘í•œ ê·¸ë˜í”„ë¡œ ê²°ê³¼ë¥¼ í™•ì¸í•´ë³´ì„¸ìš”.</div>
      </aside>
    </main>
  </div>

<script>
/* ==========================
   ë‹¤êµ­ì–´ ì§ˆë¬¸ ë°ì´í„° (ì™„ì „í•œ ë¬¸ì¥í˜•)
   ê° ì–¸ì–´ë³„ë¡œ ë™ì¼í•œ ì˜ë¯¸ì˜ ì§ˆë¬¸/ì„ íƒì§€ ì œê³µ
   ========================== */
const QUESTIONS_BY_LANG = {
  ko: [
    { q: "ì£¼ë§ì— ì¹œêµ¬ë“¤ì´ ì•½ì†ì„ ì¡ì„ ë•Œ, ë‹¹ì‹ ì€ ì–´ë–¤ ë°˜ì‘ì„ ë³´ì´ë‚˜ìš”?",
      c: [["ëˆ„êµ¬ë³´ë‹¤ ë¨¼ì € ì°¸ì—¬ ì˜ì‚¬ë¥¼ ë°íŒë‹¤","E"],["ì¡°ìš©íˆ ìƒí™©ì„ ì§€ì¼œë³¸ë‹¤","S"],["ìƒˆë¡­ê³  ì¬ë¯¸ìˆëŠ” í™œë™ì„ ì œì•ˆí•œë‹¤","O"],["ì¼ì •ì„ ê¼¼ê¼¼íˆ í™•ì¸í•œ í›„ ê²°ì •í•œë‹¤","C"]] },
    { q: "ë‚¯ì„  ì‚¬ëŒë“¤ê³¼ í•¨ê»˜ ìˆì„ ë•Œ, ë‹¹ì‹ ì˜ í–‰ë™ì€ ì–´ë–¤ê°€ìš”?",
      c: [["ë¨¼ì € ë§ì„ ê±¸ë©° ë¶„ìœ„ê¸°ë¥¼ ì´ëˆë‹¤","E"],["í•„ìš”í•  ë•Œë§Œ ì¡°ìš©íˆ ë§í•œë‹¤","S"],["ìƒˆë¡œìš´ ëŒ€í™” ì£¼ì œë¥¼ ì œì‹œí•œë‹¤","O"],["ë§í•˜ê¸° ì „ ìƒëŒ€ì˜ ë°˜ì‘ì„ ì‚´í•€ë‹¤","C"]] },
    { q: "ìƒˆë¡œìš´ ì¼ì„ ë§¡ê²Œ ë˜ì—ˆì„ ë•Œ, ë‹¹ì‹ ì€ ì–´ë–»ê²Œ ì‹œì‘í•˜ë‚˜ìš”?",
      c: [["ì‚¬ëŒë“¤ê³¼ í˜‘ë ¥í•˜ë©° ì§„í–‰í•œë‹¤","E"],["ê³„íšì„ ì„¸ìš°ê³  ì°¨ê·¼ì°¨ê·¼ í•´ë‚˜ê°„ë‹¤","C"],["ì¦‰í¥ì ìœ¼ë¡œ ì‹œë„í•˜ë©° ë°°ì›Œë‚˜ê°„ë‹¤","O"],["ì§€ì¹¨ì„ ì¶©ë¶„íˆ ìˆ™ì§€í•œ í›„ ì§„í–‰í•œë‹¤","S"]] },
    { q: "ì—¬í–‰ì„ ì¤€ë¹„í•  ë•Œ, ë‹¹ì‹ ì´ ê°€ì¥ ì¤‘ìš”í•˜ê²Œ ìƒê°í•˜ëŠ” ê²ƒì€ ë¬´ì—‡ì¸ê°€ìš”?",
      c: [["ëª¨ë‘ê°€ í•¨ê»˜ ì¦ê¸¸ ìˆ˜ ìˆëŠ” ì¼ì •","E"],["í¸ì•ˆí•˜ê³  ì•ˆì •ì ì¸ ìˆ™ì†Œ","S"],["ìƒˆë¡œìš´ ê²½í—˜ê³¼ ëª¨í—˜","O"],["ì„¸ë¶€ ì¼ì •ê³¼ ê³„íš","C"]] },
    { q: "ëª¨ì„ì—ì„œ ì˜ê²¬ì´ ë‚˜ë‰  ë•Œ, ë‹¹ì‹ ì€ ì–´ë–»ê²Œ í–‰ë™í•˜ë‚˜ìš”?",
      c: [["ë¶„ìœ„ê¸°ë¥¼ ì´ëŒë©° íƒ€í˜‘ì ì„ ì°¾ëŠ”ë‹¤","E"],["ì¡°ìš©íˆ ìƒí™©ì„ ì§€ì¼œë³´ë©° íŒë‹¨í•œë‹¤","S"],["ì°½ì˜ì ì¸ í•´ê²°ì±…ì„ ì œì‹œí•œë‹¤","O"],["ë…¼ë¦¬ì ìœ¼ë¡œ ê·¼ê±°ë¥¼ ì œì‹œí•œë‹¤","C"]] }
  ],
  en: [
    { q: "When friends plan a weekend activity, how do you usually react?",
      c: [["I volunteer to take the lead","E"],["I prefer to observe quietly","S"],["I suggest something new and fun","O"],["I check the schedule carefully before deciding","C"]] },
    { q: "When you are with strangers, how do you behave?",
      c: [["I start conversations and lead the mood","E"],["I speak only when necessary","S"],["I bring up new topics to talk about","O"],["I observe reactions before speaking","C"]] },
    { q: "When assigned a new task, how do you get started?",
      c: [["I collaborate with others","E"],["I plan and proceed step by step","C"],["I try things spontaneously and learn","O"],["I study the guidelines thoroughly then proceed","S"]] },
    { q: "When preparing a trip, what matters most to you?",
      c: [["An itinerary everyone can enjoy","E"],["Comfortable and stable lodging","S"],["New experiences and adventure","O"],["Detailed schedule and planning","C"]] },
    { q: "When opinions split in a meeting, how do you act?",
      c: [["I lead and find compromises","E"],["I quietly assess and decide","S"],["I propose creative solutions","O"],["I present logical evidence","C"]] }
  ],
  ja: [
    { q: "é€±æœ«ã«å‹é”ãŒäºˆå®šã‚’ç«‹ã¦ã‚‹ã¨ãã€ã‚ãªãŸã¯ã©ã†åå¿œã—ã¾ã™ã‹ï¼Ÿ",
      c: [["ç‡å…ˆã—ã¦è¨ˆç”»ã‚’ç«‹ã¦ã‚‹","E"],["é™ã‹ã«æ§˜å­ã‚’è¦‹ã‚‹","S"],["æ–°ã—ãã¦æ¥½ã—ã„æ¡ˆã‚’ææ¡ˆã™ã‚‹","O"],["äºˆå®šã‚’ã‚ˆãç¢ºèªã—ã¦ã‹ã‚‰æ±ºã‚ã‚‹","C"]] },
    { q: "çŸ¥ã‚‰ãªã„äººã¨ä¸€ç·’ã«ã„ã‚‹ã¨ãã€ã‚ãªãŸã¯ã©ã†æŒ¯ã‚‹èˆã„ã¾ã™ã‹ï¼Ÿ",
      c: [["è‡ªåˆ†ã‹ã‚‰è©±ã—ã‹ã‘ã¦å ´ã‚’ç››ã‚Šä¸Šã’ã‚‹","E"],["å¿…è¦ãªã¨ãã ã‘è©±ã™","S"],["æ–°ã—ã„è©±é¡Œã‚’æä¾›ã™ã‚‹","O"],["è©±ã™å‰ã«ç›¸æ‰‹ã®åå¿œã‚’è¦³å¯Ÿã™ã‚‹","C"]] },
    { q: "æ–°ã—ã„ä»•äº‹ã‚’ä»»ã•ã‚ŒãŸã¨ãã€ã©ã†å§‹ã‚ã¾ã™ã‹ï¼Ÿ",
      c: [["äººã¨å”åŠ›ã—ã¦é€²ã‚ã‚‹","E"],["è¨ˆç”»ã‚’ç«‹ã¦ã¦ç€å®Ÿã«é€²ã‚ã‚‹","C"],["å³èˆˆã§è©¦ã—ãªãŒã‚‰å­¦ã¶","O"],["æŒ‡ç¤ºã‚’ååˆ†ã«ç†è§£ã—ã¦ã‹ã‚‰é€²ã‚ã‚‹","S"]] },
    { q: "æ—…è¡Œã‚’æº–å‚™ã™ã‚‹ã¨ãã€ã‚ãªãŸãŒé‡è¦–ã™ã‚‹ã“ã¨ã¯ä½•ã§ã™ã‹ï¼Ÿ",
      c: [["çš†ã§æ¥½ã—ã‚ã‚‹ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«","E"],["å¿«é©ã§å®‰å®šã—ãŸå®¿æ³Š","S"],["æ–°ã—ã„ä½“é¨“ã¨å†’é™º","O"],["è©³ç´°ãªäºˆå®šã¨è¨ˆç”»","C"]] },
    { q: "ä¼šè­°ã§æ„è¦‹ãŒåˆ†ã‹ã‚ŒãŸã¨ãã€ã©ã†è¡Œå‹•ã—ã¾ã™ã‹ï¼Ÿ",
      c: [["å ´ã‚’ãƒªãƒ¼ãƒ‰ã—ã¦å¦¥å”ç‚¹ã‚’è¦‹ã¤ã‘ã‚‹","E"],["é™ã‹ã«åˆ¤æ–­ã™ã‚‹","S"],["å‰µé€ çš„ãªè§£æ±ºç­–ã‚’ææ¡ˆã™ã‚‹","O"],["è«–ç†çš„ã«æ ¹æ‹ ã‚’ç¤ºã™","C"]] }
  ],
  fr: [
    { q: "Quand des amis planifient un week-end, comment rÃ©agissez-vous ?",
      c: [["Je prends l'initiative","E"],["J'observe tranquillement","S"],["Je propose quelque chose de nouveau et amusant","O"],["Je vÃ©rifie l'emploi du temps avant de dÃ©cider","C"]] },
    { q: "Avec des inconnus, comment vous comportez-vous ?",
      c: [["J'engage la conversation et anime l'ambiance","E"],["Je parle seulement si nÃ©cessaire","S"],["Je propose de nouveaux sujets","O"],["J'observe les rÃ©actions avant de parler","C"]] },
    { q: "Lorsque vous avez une nouvelle mission, comment commencez-vous ?",
      c: [["Je collabore avec les autres","E"],["Je planifie et avance Ã©tape par Ã©tape","C"],["J'essaie spontanÃ©ment et j'apprends","O"],["Je lis attentivement les consignes puis j'agis","S"]] },
    { q: "En prÃ©parant un voyage, qu'est-ce qui compte le plus ?",
      c: [["Un itinÃ©raire que tout le monde apprÃ©cie","E"],["Un hÃ©bergement confortable et stable","S"],["De nouvelles expÃ©riences et de l'aventure","O"],["Un planning dÃ©taillÃ©","C"]] },
    { q: "Si les avis divergent en rÃ©union, que faites-vous ?",
      c: [["Je mÃ¨ne et trouve un compromis","E"],["J'observe et juge calmement","S"],["Je propose des solutions crÃ©atives","O"],["Je prÃ©sente des arguments logiques","C"]] }
  ],
  es: [
    { q: "Cuando amigos planean el fin de semana, Â¿cÃ³mo reaccionas?",
      c: [["Tomo la iniciativa","E"],["Observo en silencio","S"],["Propongo algo nuevo y divertido","O"],["Reviso el horario antes de decidir","C"]] },
    { q: "Con personas desconocidas, Â¿cÃ³mo te comportas?",
      c: [["Inicio la conversaciÃ³n y animo el ambiente","E"],["Hablo sÃ³lo si es necesario","S"],["Propongo nuevos temas","O"],["Observo las reacciones antes de hablar","C"]] },
    { q: "Al recibir una nueva tarea, Â¿cÃ³mo empiezas?",
      c: [["Colaboro con otros","E"],["Planifico y avanzo paso a paso","C"],["Pruebo espontÃ¡neamente y aprendo","O"],["Estudio las instrucciones y luego actÃºo","S"]] },
    { q: "Al preparar un viaje, Â¿quÃ© te importa mÃ¡s?",
      c: [["Un itinerario para que todos disfruten","E"],["Alojamiento cÃ³modo y estable","S"],["Nuevas experiencias y aventuras","O"],["Un plan detallado","C"]] },
    { q: "Si hay opiniones divididas en una reuniÃ³n, Â¿quÃ© haces?",
      c: [["Lidero y busco un compromiso","E"],["EvalÃºo tranquilamente","S"],["Propongo soluciones creativas","O"],["Presento argumentos lÃ³gicos","C"]] }
  ]
};

/* ---------- ì•± ìƒíƒœ ---------- */
let lang = 'ko';
let questions = [];
let selectedQuestions = [];
let qIndex = 0;
let scores = {E:0,S:0,O:0,C:0};
let chartInstance = null;
let currentChartType = 'bar';
let compareAverage = false;

/* ---------- ìœ í‹¸: DOM ---------- */
const langSelect = document.getElementById('langSelect');
const startBtn = document.getElementById('startBtn');
const introText = document.getElementById('introText');
const startBox = document.getElementById('startBox');
const questionCard = document.getElementById('questionCard');
const questionTitle = document.getElementById('questionTitle');
const choicesDiv = document.getElementById('choices');
const progressFill = document.getElementById('progressFill');
const resultCard = document.getElementById('resultCard');
const resultTitle = document.getElementById('resultTitle');
const resultSummary = document.getElementById('resultSummary');
const chartTypeSelect = document.getElementById('chartType');
const compareCheckbox = document.getElementById('compareAvg');
const downloadBtn = document.getElementById('downloadBtn');
const shareBtn = document.getElementById('shareBtn');
const restartBtn = document.getElementById('restartBtn');
const resultChartCanvas = document.getElementById('resultChart');

/* ---------- ì´ˆê¸°í™”: ì–¸ì–´ ì„ íƒ ì˜µì…˜ ì±„ìš°ê¸° & ìë™ê°ì§€ ---------- */
function initLangOptions(){
  const langs = Object.keys(QUESTIONS_BY_LANG);
  langSelect.innerHTML = '';
  langs.forEach(l=>{
    const opt = document.createElement('option');
    opt.value = l;
    opt.innerText = {ko:'í•œêµ­ì–´',en:'English',ja:'æ—¥æœ¬èª',fr:'FranÃ§ais',es:'EspaÃ±ol'}[l] || l;
    langSelect.appendChild(opt);
  });

  // ìë™ ê°ì§€
  const userLang = navigator.language ? navigator.language.slice(0,2) : 'ko';
  if(QUESTIONS_BY_LANG[userLang]) lang = userLang;
  langSelect.value = lang;
  applyLangTexts();
}
function applyLangTexts(){
  const intro = {
    ko: "ì§ˆë¬¸ì— ë‹µí•˜ë©´ E/S/O/C ì„±í–¥ì„ ë¶„ì„í•´ ë“œë¦½ë‹ˆë‹¤. ì–¸ì–´ë¥¼ ì„ íƒí•œ ë’¤ ì‹œì‘í•˜ì„¸ìš”.",
    en: "Answer the questions to analyze your E/S/O/C traits. Choose a language and start.",
    ja: "è³ªå•ã«ç­”ãˆã‚‹ã¨ E/S/O/C ã®å‚¾å‘ã‚’åˆ†æã—ã¾ã™ã€‚è¨€èªã‚’é¸ã‚“ã§é–‹å§‹ã—ã¦ãã ã•ã„ã€‚",
    fr: "RÃ©pondez aux questions pour analyser vos traits E/S/O/C. Choisissez la langue et dÃ©marrez.",
    es: "Responde las preguntas para analizar tus rasgos E/S/O/C. Elige el idioma y comienza."
  }[lang] || '';
  introText.innerText = intro;
  startBtn.innerText = {ko:'ì‹œì‘',en:'Start',ja:'é–‹å§‹',fr:'Commencer',es:'Comenzar'}[lang] || 'Start';
  resultTitle.innerText = {ko:'ê²°ê³¼',en:'Result',ja:'çµæœ',fr:'RÃ©sultat',es:'Resultado'}[lang] || 'Result';
}

/* ---------- ì‹œì‘ ë¡œì§ ---------- */
startBtn.addEventListener('click', startQuiz);
langSelect.addEventListener('change', e=>{ lang = e.target.value; applyLangTexts(); });

function startQuiz(){
  // ì´ˆê¸°í™”
  questions = QUESTIONS_BY_LANG[lang];
  selectedQuestions = shuffle(questions).slice(0,5);
  qIndex = 0;
  scores = {E:0,S:0,O:0,C:0};
  startBox.style.display = 'none';
  questionCard.style.display = 'block';
  resultCard.style.display = 'none';
  progressFill.style.width = '0%';
  speakLocalizedIntro();
  showQuestion();
}

/* ---------- ì§ˆë¬¸ ë Œë”ë§ ---------- */
function showQuestion(){
  const q = selectedQuestions[qIndex];
  questionTitle.innerText = `(${qIndex+1}/${selectedQuestions.length}) ${q.q}`;
  choicesDiv.innerHTML = '';
  const shuffled = shuffle(q.c);
  shuffled.forEach(([txt, trait], idx)=>{
    const div = document.createElement('div');
    div.className = 'choice';
    div.tabIndex = 0;
    div.innerText = txt;
    div.onclick = (ev) => { onChoiceSelected(div, trait); };
    div.onkeydown = (ev) => { if(ev.key === 'Enter' || ev.key === ' ') onChoiceSelected(div, trait); };
    choicesDiv.appendChild(div);
  });
  progressFill.style.width = `${(qIndex / selectedQuestions.length) * 100}%`;
  speak(q.q);
}

/* ---------- ì„ íƒ ì²˜ë¦¬ ---------- */
function onChoiceSelected(div, trait){
  // UI í”¼ë“œë°±
  const nodes = choicesDiv.querySelectorAll('.choice');
  nodes.forEach(n=>n.classList.remove('selected'));
  div.classList.add('selected');

  setTimeout(()=>{
    scores[trait] = (scores[trait] || 0) + 1;
    qIndex++;
    if(qIndex < selectedQuestions.length) showQuestion();
    else finishQuiz();
  }, 240);
}

/* ---------- ê²°ê³¼ ì²˜ë¦¬ ---------- */
function finishQuiz(){
  questionCard.style.display = 'none';
  resultCard.style.display = 'block';
  progressFill.style.width = '100%';

  const sorted = Object.entries(scores).sort((a,b)=>b[1]-a[1]);
  const top3 = sorted.slice(0,3).map(e=>e[0]).join('');
  const desc = getDescriptionByType(top3);
  resultSummary.innerText = {
    ko: `ìœ í˜•: ${top3} â€” ${desc}`,
    en: `Type: ${top3} â€” ${desc}`,
    ja: `ã‚¿ã‚¤ãƒ—: ${top3} â€” ${desc}`,
    fr: `Type: ${top3} â€” ${desc}`,
    es: `Tipo: ${top3} â€” ${desc}`
  }[lang] || `Type: ${top3} â€” ${desc}`;

  // prepare data for chart
  const scoresForChart = { ...scores }; // E,S,O,C
  currentChartType = chartTypeSelect.value || 'bar';
  compareAverage = compareCheckbox.checked;
  renderResultChart(scoresForChart, currentChartType, compareAverage);
  speakResult(top3, desc);
}

/* ---------- ì°¨íŠ¸ ë Œë”ë§ ---------- */
function getChartColors(dark=false){
  // E,S,O,C colors
  if(!dark) return ['#4A90E2','#7ED321','#F5A623','#9013FE'];
  return ['#60a5fa','#34d399','#f59e0b','#a78bfa'];
}

function renderResultChart(scoresObj, chartType='bar', compare=false){
  const ctx = resultChartCanvas.getContext('2d');
  if(chartInstance) chartInstance.destroy();

  const labels = ['E','S','O','C'];
  const dataValues = labels.map(l => scoresObj[l] || 0);
  const colors = getChartColors(document.body.classList.contains('dark'));

  const datasets = [
    {
      label: (lang==='ko'?'ë‚˜':'You'),
      data: dataValues,
      backgroundColor: colors,
      borderColor: colors.map(c=>'rgba(255,255,255,0.06)'),
      borderWidth: 1,
    }
  ];

  if(compare){
    // Example average values (you can replace with real averages)
    const avgValues = [2.2,1.8,2.4,2.1]; // dummy average values (0-5 scale)
    datasets.push({
      label: (lang==='ko'?'í‰ê· ':'Avg'),
      data: avgValues,
      backgroundColor: colors.map(c => hexToRgba(c,0.24)),
      borderColor: colors,
      borderWidth: 1,
    });
  }

  const options = {
    responsive: true,
    maintainAspectRatio: false,
    plugins:{
      legend:{ position:'top', labels:{boxWidth:12}},
      tooltip:{
        callbacks:{
          label: ctx => `${ctx.dataset.label}: ${ctx.parsed.y !== undefined ? ctx.parsed.y : ctx.raw}`
        }
      },
      title: {
        display: true,
        text: {ko:'ë‹¹ì‹ ì˜ ì„±í–¥ ë¶„ì„', en:'Your trait analysis', ja:'ã‚ãªãŸã®å‚¾å‘', fr:'Analyse de vos traits', es:'AnÃ¡lisis de rasgos'}[lang] || 'Result'
      }
    },
    animation:{ duration:1000, easing:'easeOutQuart' }
  };

  const cfg = {
    type: chartType,
    data: { labels: labels, datasets: datasets },
    options: options
  };

  // radar chart needs different options: set scales
  if(chartType === 'radar'){
    cfg.options = {
      ...cfg.options,
      elements: { line: { borderWidth: 2 } },
      scales: { r: { suggestedMin:0, suggestedMax:5, ticks: { stepSize:1 } } }
    };
  } else if(chartType === 'doughnut' || chartType === 'pie'){
    // doughnut/pie don't use y-axis
    cfg.options.plugins.tooltip.callbacks.label = ctx => `${ctx.label}: ${ctx.raw}`;
  } else {
    cfg.options.scales = { y: { beginAtZero:true, suggestedMax:5, ticks: { stepSize:1 } } };
  }

  chartInstance = new Chart(ctx, cfg);
}

/* ---------- ìœ í‹¸: hex->rgba ---------- */
function hexToRgba(hex, alpha=0.5){
  const h = hex.replace('#','');
  const bigint = parseInt(h,16);
  const r = (bigint >> 16) & 255;
  const g = (bigint >> 8) & 255;
  const b = bigint & 255;
  return `rgba(${r},${g},${b},${alpha})`;
}

/* ---------- ê³µìœ  / ì €ì¥ ---------- */
downloadBtn.addEventListener('click', ()=>{
  if(!chartInstance) return alert({ko:'ì°¨íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤',en:'No chart',ja:'ãƒãƒ£ãƒ¼ãƒˆãŒã‚ã‚Šã¾ã›ã‚“'}[lang]);
  const url = chartInstance.toBase64Image();
  const a = document.createElement('a');
  a.href = url;
  a.download = `psychotest_chart_${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.png`;
  document.body.appendChild(a);
  a.click();
  a.remove();
});

shareBtn.addEventListener('click', async ()=>{
  const text = resultSummary.innerText;
  const url = window.location.href;
  if(navigator.share){
    try{ await navigator.share({ title:'ì‹¬ë¦¬í…ŒìŠ¤íŠ¸ ê²°ê³¼', text, url }); }
    catch(e){ console.log('share canceled'); }
  } else {
    try{
      await navigator.clipboard.writeText(`${text}\n${url}`);
      alert({ko:'ê²°ê³¼ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤',en:'Result copied',ja:'çµæœã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ'}[lang] || 'Copied');
    }catch(e){
      alert('Share not supported');
    }
  }
});

/* ---------- ì¬ì‹œì‘ ---------- */
restartBtn.addEventListener('click', ()=>{
  resultCard.style.display = 'none';
  startBox.style.display = 'block';
  if(chartInstance) chartInstance.destroy();
});

/* ---------- ì°¨íŠ¸ ì»¨íŠ¸ë¡¤ ë³€í™” ---------- */
chartTypeSelect.addEventListener('change', ()=>{
  currentChartType = chartTypeSelect.value;
  // re-render if result exists
  if(resultCard.style.display !== 'none'){
    renderResultChart(scores, currentChartType, compareCheckbox.checked);
  }
});
compareCheckbox.addEventListener('change', ()=>{
  compareAverage = compareCheckbox.checked;
  if(resultCard.style.display !== 'none'){
    renderResultChart(scores, currentChartType, compareAverage);
  }
});

/* ---------- ìŒì„± ì•ˆë‚´ (TTS) ---------- */
const isSpeechSupported = 'speechSynthesis' in window;
function speak(text){
  if(!isSpeechSupported) return showFallbackToast(text);
  try{
    window.speechSynthesis.cancel();
    const u = new SpeechSynthesisUtterance(text);
    const langMap = {ko:'ko-KR', en:'en-US', ja:'ja-JP', fr:'fr-FR', es:'es-ES'};
    u.lang = langMap[lang] || 'en-US';
    u.rate = 1;
    u.pitch = 1;
    window.speechSynthesis.speak(u);
  }catch(e){
    console.warn('TTS error', e);
  }
}
function speakLocalizedIntro(){
  const intro = {
    ko: "í…ŒìŠ¤íŠ¸ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤. ì§ˆë¬¸ì„ ì˜ ë“£ê³  ë‹µí•´ì£¼ì„¸ìš”.",
    en: "Starting the test. Please listen and answer the questions.",
    ja: "ãƒ†ã‚¹ãƒˆã‚’é–‹å§‹ã—ã¾ã™ã€‚è³ªå•ã«è€³ã‚’å‚¾ã‘ã¦å›ç­”ã—ã¦ãã ã•ã„ã€‚",
    fr: "DÃ©marrage du test. Veuillez Ã©couter et rÃ©pondre aux questions.",
    es: "Iniciando la prueba. Por favor, escucha y responde las preguntas."
  }[lang] || '';
  speak(intro);
}
function speakResult(type, desc){
  const texts = {
    ko: `ê²°ê³¼: ${type}. ${desc}`,
    en: `Result: ${type}. ${desc}`,
    ja: `çµæœ: ${type}. ${desc}`,
    fr: `RÃ©sultat: ${type}. ${desc}`,
    es: `Resultado: ${type}. ${desc}`
  }[lang] || `Result: ${type}. ${desc}`;
  speak(texts);
}
function showFallbackToast(text){
  const id = 'tts-fallback';
  const existing = document.getElementById(id);
  if(existing) existing.remove();
  const el = document.createElement('div');
  el.id = id;
  el.innerText = `ğŸ”ˆ ${text}`;
  Object.assign(el.style,{position:'fixed',bottom:'18px',left:'50%',transform:'translateX(-50%)',background:'rgba(2,6,23,0.85)',color:'#fff',padding:'10px 14px',borderRadius:'10px',zIndex:9999});
  document.body.appendChild(el);
  setTimeout(()=>el.remove(),3500);
}

/* ---------- ì„¤ëª…(íƒ€ì…) ---------- */
function getDescriptionByType(type){
  // simple mapping â€” could be expanded
  const map = {
    ko: {
      EOC: "ì‚¬êµì ì´ë©° ì°½ì˜ì ì´ê³  ì²´ê³„ì ì¸ ë¦¬ë”í˜•ì…ë‹ˆë‹¤.",
      ESC: "í˜„ì‹¤ì ì´ë©° ì‹ ë¢°ë°›ëŠ” í˜‘ë ¥ê°€í˜•ì…ë‹ˆë‹¤.",
      EO: "í™œë°œí•˜ê³  ì•„ì´ë””ì–´ê°€ í’ë¶€í•œ íƒí—˜ê°€í˜•ì…ë‹ˆë‹¤.",
      SC: "ì°¨ë¶„í•˜ê³  ì±…ì„ê° ìˆëŠ” ë¶„ì„ê°€í˜•ì…ë‹ˆë‹¤.",
      OC: "ì°½ì˜ì ì´ê³  ê³„íšì ì¸ í˜ì‹ ê°€í˜•ì…ë‹ˆë‹¤."
    },
    en: {
      EOC: "Sociable, creative and organized â€” a leader type.",
      ESC: "Practical and reliable â€” a dependable collaborator.",
      EO: "Energetic and idea-rich â€” an explorer type.",
      SC: "Calm and responsible â€” an analytical type.",
      OC: "Creative and methodical â€” an innovator type."
    }
  };
  // try to find best key match
  const k = type || '';
  return map[lang]?.[k] || map['ko']?.[k] || (lang==='en'? "Balanced, multi-trait type.": "ê· í˜• ì¡íŒ ì„±í–¥ì…ë‹ˆë‹¤.");
}

/* ---------- small helpers ---------- */
function shuffle(arr){ return arr.slice().sort(()=>Math.random()-0.5); }

/* ---------- init ---------- */
initLangOptions();

/* ---------- Accessibility: keyboard enter on start ---------- */
startBtn.addEventListener('keydown', e=>{ if(e.key === 'Enter') startBtn.click(); });

</script>
</body>
</html>
